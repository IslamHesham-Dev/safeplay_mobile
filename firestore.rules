rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function childExists(childId) {
      return childId is string &&
        exists(/databases/$(database)/documents/children/$(childId));
    }

    function canManageBrowserControls(childId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/children/$(childId)) &&
        (
          request.auth.uid in get(/databases/$(database)/documents/children/$(childId)).data.parentIds ||
          request.auth.uid in get(/databases/$(database)/documents/children/$(childId)).data.counselorIds ||
          request.auth.uid in get(/databases/$(database)/documents/children/$(childId)).data.teacherIds
        );
    }

    function childDeviceReadAllowed(childId) {
      return request.auth == null && childExists(childId);
    }

    // Users can read and write their own user document
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Children documents - parents can create/read/update their children, counselors/teachers can read/write
    match /children/{childId} {
      function isAuthorizedForExistingChild() {
        return request.auth != null && (
          (resource.data.parentIds is list && request.auth.uid in resource.data.parentIds) ||
          (resource.data.counselorIds is list && request.auth.uid in resource.data.counselorIds) ||
          (resource.data.teacherIds is list && request.auth.uid in resource.data.teacherIds) ||
          // Allow accessing if parentId field exists (legacy support)
          (('parentId' in resource.data) && request.auth.uid == resource.data.parentId)
        );
      }

      function isAuthorizedForChildCreate() {
        return request.auth != null && (
          // Allow parents to create children if they are in the parentIds array
          (request.resource.data.parentIds is list && request.auth.uid in request.resource.data.parentIds) ||
          // Allow counselors and teachers to create children
          (request.resource.data.counselorIds is list && request.auth.uid in request.resource.data.counselorIds) ||
          (request.resource.data.teacherIds is list && request.auth.uid in request.resource.data.teacherIds) ||
          // Allow creation if parentId field is set (legacy support)
          (('parentId' in request.resource.data) && request.auth.uid == request.resource.data.parentId)
        );
      }

      function isValidStandaloneChildCreation() {
        return request.auth == null &&
          request.resource.data.name is string &&
          request.resource.data.name.size() > 0 &&
          request.resource.data.userType is string &&
          request.resource.data.userType in ['juniorChild', 'brightChild'] &&
          request.resource.data.ageGroup is string &&
          request.resource.data.ageGroup in ['junior', 'bright'] &&
          request.resource.data.parentIds is list &&
          request.resource.data.parentIds.size() == 0 &&
          (!('parentId' in request.resource.data) || request.resource.data.parentId == null || request.resource.data.parentId == '') &&
          (!('teacherIds' in request.resource.data) || (request.resource.data.teacherIds is list && request.resource.data.teacherIds.size() == 0)) &&
          (!('counselorIds' in request.resource.data) || (request.resource.data.counselorIds is list && request.resource.data.counselorIds.size() == 0));
      }

      // Allow public reads so children can discover their profile for login.
      allow read: if true;
      allow create: if isAuthorizedForChildCreate() || isValidStandaloneChildCreation();
      allow update: if isAuthorizedForExistingChild();
      allow delete: if isAuthorizedForExistingChild();
    }
    
    // Mood entries - counselors and teachers can read/write, parents can read their children's entries
    match /moodEntries/{entryId} {
      allow read: if request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.parentIds ||
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.counselorIds ||
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.teacherIds
      );
      allow write: if request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.counselorIds ||
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.teacherIds
      );
    }
    
    // Incidents - counselors and teachers can read/write, parents can read incidents involving their children
    match /incidents/{incidentId} {
      allow read: if request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.parentIds ||
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.counselorIds ||
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.teacherIds
      );
      allow write: if request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.counselorIds ||
        request.auth.uid in get(/databases/$(database)/documents/children/$(resource.data.childId)).data.teacherIds
      );
    }
    
    // Counselor notes - only counselors can read/write their own notes
    match /counselorNotes/{noteId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.authorId;
    }
    
    // Activities - everyone can read and write for development
    match /activities/{activityId} {
      allow read, write: if request.auth != null;
    }
    
    // Activity completions - allow all authenticated users for development
    match /activityCompletions/{completionId} {
      allow read, write: if request.auth != null;
    }
    
    // Activity progress - allow all authenticated users for development
    match /activityProgress/{progressId} {
      allow read, write: if request.auth != null;
    }
    
    // Auth logs - allow all authenticated users for development
    match /authLogs/{logId} {
      allow read, write: if request.auth != null;
    }
    
    // Notifications - allow all authenticated users for development
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null;
    }

    // Teacher broadcasts (teachers write, children read without auth)
    match /teacherBroadcasts/{broadcastId} {
      allow read: if true;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.teacherId;
      allow update, delete: if request.auth != null &&
        request.auth.uid == resource.data.teacherId;
    }

    // Teacher inbox messages (teachers read, children submit replies)
    match /teacherInboxMessages/{messageId} {
      allow read: if request.auth != null &&
        request.auth.uid == resource.data.teacherId;
      allow create: if request.auth != null ||
        childExists(request.resource.data.childId);
      allow update, delete: if request.auth != null &&
        request.auth.uid == resource.data.teacherId;
    }
    
    // Question templates - allow reading active templates (for children to access games)
    // Children may not be authenticated, so allow unauthenticated reads for published content
    match /questionTemplates/{templateId} {
      // Allow read if template is active and matches age group (anyone can read published templates)
      allow read: if resource.data.isActive == true &&
        (resource.data.ageGroups is list && 
         ('junior' in resource.data.ageGroups || 
          'bright' in resource.data.ageGroups));
      
      // Allow write only for authenticated users (teachers/admins)
      allow write: if request.auth != null;
    }
    
    // Activities - allow reading published activities (for children to play games)
    // Children may not be authenticated, so allow unauthenticated reads for published content
    match /activities/{activityId} {
      // Allow read if published (anyone can read published activities)
      allow read: if 
        resource.data.published == true && 
        resource.data.publishState == 'published' &&
        resource.data.ageGroup in ['junior', 'bright'];
      
      // Allow write only for authenticated users (teachers/admins)
      allow write: if request.auth != null;
    }

    // Browser control settings scoped to each child
    match /browserControls/{childId} {
      allow read: if canManageBrowserControls(childId) || childDeviceReadAllowed(childId);
      allow write: if canManageBrowserControls(childId);
    }
    
    // Default allow rule for development - remove this in production
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
